name: ci

on:
  pull_request:
  push:

env:
  SH: 'docker exec -t os-3.0.1 bash -c '

jobs:
  before_install:
    name: before_install
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
    - name: Setup Ruby
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.5'
    - name: Setup Docker
      run: |
        docker pull nrel/openstudio:3.0.1
        docker images --all
        docker run -d --name os-3.0.1 -e LANG=C.UTF-8 -v $(pwd):/travis -w /travis nrel/openstudio:3.0.1 tail -f /dev/null
        docker ps -a
        pwd
        ls
        $SH "env"
        $SH "echo $LANG"
        $SH "gem install bundler"
        $SH "bundle -v"
    - name: Save Docker
      run: |
        docker commit -p $(docker ps -l -q) os-3.0.1 
        docker save -o container.tar os-3.0.1
    - name: Upload Container
      uses: actions/upload-artifact@v2
      with:
        name: container
        path: container.tar

  install:
    name: install
    runs-on: ubuntu-latest
    needs: before_install
    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
    - name: Setup Ruby
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.5'
    - name: Download Container
      uses: actions/download-artifact@v2
      with:
        name: container
    - name: debug print
      run: ls
    - name: start container
      run: |
        docker load -i container.tar
        docker run os-3.0.1
    - run: $SH "bundle install --path ."
